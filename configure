#!/bin/bash
#
# The "u2up-build" project build rules
#
# Copyright (C) 2017-2018 Samo Pogacnik <samo_pogacnik@t-2.net>
# All rights reserved.
#
# This file is part of the "u2up-build" software project.
# This file is provided under the terms of the BSD 3-Clause license,
# available in the LICENSE file of the "u2up-build" software project.
#
#set -x
set -e

if [ "x"$SRCDIR != "x" ];
then
	cd $SRCDIR
	_SRCDIR_=$(pwd)
	cd - > /dev/null
else
	cd $(dirname $(which $0))
	_SRCDIR_=$(pwd)
	cd - > /dev/null
fi
export _SRCDIR_
echo "Local source absolute path (SRCDIR): "$_SRCDIR_

if [ "x"$BUILDIR != "x" ];
then
	mkdir -p $BUILDIR
	cd $BUILDIR
	_BUILDIR_=$(pwd)
	cd - > /dev/null
else
	BUILDIR="."
	_BUILDIR_=$(pwd)
fi
export _BUILDIR_
echo "Local build absolute path (BUILDIR): "$_BUILDIR_

if [ -f $_BUILDIR_/Makefile ];
then
	echo "ERROR: Local build path already configured!"
	exit 1
fi

if [ "x"$PREFIX == "x" ]
then
	PREFIX="/"
	echo "Target absolute installation prefix path (PREFIX): "$PREFIX
else
	echo "Target absolute installation prefix path (PREFIX): "$PREFIX
	if [ "/" != $(echo $PREFIX | sed -e 's%^/.*%/%') ];
	then
		echo "ERROR: Target installation path PREFIX is not absolute!"
		exit 1
	fi
fi
export PREFIX

if [ "x"$DESTDIR == "x" ]
then
	echo "--"
	echo "Later (in the installation command), you may provide additional absolute"
	echo "target installation path prefix via the DESTDIR environment variable!"
	echo "--"
else
	echo "Additional absolute target installation path prefix (DESTDIR): "$DESTDIR
	if [ "/" != $(echo $DESTDIR | sed -e 's%^/.*%/%') ];
	then
		echo "ERROR: Additional target installation path DESTDIR is not absolute!"
		exit 1
	fi
	export DESTDIR
fi

make -C $_BUILDIR_ -f $_SRCDIR_/conf.mk conf

